<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-9209860-4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-9209860-4');
</script>


    <meta charset="utf-8" />
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Cloudant: CouchDB as Backend &middot; pksunkara</title>

    <meta name="description" content="My personal blog" />

    <link href="https://pksunkara.com/atom.xml" rel="alternate" type="application/atom+xml" title="pksunkara" />

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="canonical" href="https://pksunkara.com/posts/cloudant-couchdb-as-backend/" />

    <!-- <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/rrssb/1.14.0/css/rrssb.css"> -->
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,700italic,300,700%7CBree+Serif">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Fira+Mono&display=swap">

    <link rel="stylesheet" type="text/css" href="https://pksunkara.com/css/rrssb.css">
    <link rel="stylesheet" type="text/css" href="https://pksunkara.com/css/crisp.css">
    <link rel="stylesheet" type="text/css" href="https://pksunkara.com/css/app.css">

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/rrssb/1.14.0/js/rrssb.min.js"></script>

    
  </head>
  <body>
    <header id="header">
      <a id="logo" href="https://pksunkara.com"><img src="https://www.gravatar.com/avatar/39863b6141d1be3ec211dca4b061cd5e.png?s=400" alt="pksunkara" /></a>
      <h1><a href="https://pksunkara.com">pksunkara</a></h1>
      <p>My personal blog</p>

      <div id="follow-icons">
  <a href="http://github.com/pksunkara" rel="me"><i class="fa fa-github-square fa-2x"></i></a>
  <a href="http://twitter.com/pksunkara" rel="me"><i class="fa fa-twitter-square fa-2x"></i></a>
  <a href="http://facebook.com/pksunkara" rel="me"><i class="fa fa-facebook-square fa-2x"></i></a>
  <a href="https://pksunkara.com/atom.xml" rel="me"><i class="fa fa-rss-square fa-2x"></i></a>
</div>

      <h6><a href="/about">About</a></h6>

    </header>

    
<main id="content">
  <article id="cloudant-couchdb-as-backend" class="_index.md-posts/_index.md">
    
<div class="post-stamp">
  <time datetime="2016-10-01T15:25:32+02:00">
  Oct  1, 2016
</time>

  
  <span class="taglist">
    &middot;
    
      <a href="https://pksunkara.com/tags/database/">database</a>
    
      <a href="https://pksunkara.com/tags/couchdb/">couchdb</a>
    
      <a href="https://pksunkara.com/tags/cloudant/">cloudant</a>
    
  </span>


</div>
<h1 class="post-title">Cloudant: CouchDB as Backend</h1>
<p>There have been a <a href="http://blog.mattwoodward.com/2012/03/definitive-guide-to-couchdb.html">lot</a> <a href="http://www.staticshin.com/programming/easy-user-accounts-management-with-couchdb/">of</a> <a href="https://nolanlawson.com/2013/11/15/couchdb-doesnt-want-to-be-your-database-it-wants-to-be-your-web-site/">guides</a> on how to use <a href="http://couchdb.apache.org">CouchDB</a> as a database for the web while restricting users to write only the data they own. I have been recently experimenting with how to use <a href="https://cloudant.com">Cloudant</a>'s CouchDB as a backend directly for one of my Single Page Applications [<strong>SPA</strong>]. This blog post gives a little perspective on the limitations of the idea and how to achieve it.</p>
<h2 id="limitations"><a class="permalink" href="#limitations">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    20
  
" height="
  
    20
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Limitations</h2>
<p>The number one major limitation of CouchDB-as-a-backend is that every user can read all the data. This makes it not suitable for some kind of applications (finance etc..) but really well suited for other kinds of things. One famous example of this would be <a href="https://npmjs.com">NPM</a>, Node.js package manager.</p>
<p>The other major limitation is that there's no password recovery. You can't just say &quot;<em>give your email, weâ€™ll send you a new one</em>&quot;. Fortunately, you can bypass this by using <a href="https://en.wikipedia.org/wiki/Single_sign-on">Single sign-on</a>. I have personally decided to use <a href="https://auth0.com">Auth0</a> in my <strong>SPA</strong>.</p>
<h2 id="setting-up"><a class="permalink" href="#setting-up">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    20
  
" height="
  
    20
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Setting up</h2>
<p>I have listed below the steps on how to achieve this <a href="https://cloudant.com">Cloudant</a>. I am going to assume that you have an account ready to go with username <strong>name</strong> and password <strong>pass</strong>. Let's use the <a href="https://npmjs.com">NPM</a> service as an example.</p>
<h4 id="create-users-database"><a class="permalink" href="#create-users-database">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    16
  
" height="
  
    16
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Create Users Database</h4>
<p>You need to create an <strong>_users</strong> database which will be used for user authentication and authorization.</p>
<pre style="background-color:#f9f9f9;">
<code class="language-bash" data-lang="bash"><span style="color:#c82728;">curl</span><span style="color:#f07219;"> -X</span><span style="color:#4271ae;"> PUT</span><span style="color:#f07219;"> -u</span><span style="color:#4271ae;"> name:pass https://name.cloudant.com/_users
</span></code></pre><h6 id="turn-off-cloudant-security"><a class="permalink" href="#turn-off-cloudant-security">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    12
  
" height="
  
    12
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Turn off Cloudant Security</h6>
<p>You need to turn off <a href="https://cloudant.com">Cloudant</a>'s security for this database so that you can allow anyone to register themselves as user.</p>
<p>Create the security document which needs to be uploaded as <strong>security.json</strong>.</p>
<pre style="background-color:#f9f9f9;">
<code class="language-json" data-lang="json"><span style="color:#111111;">{
  </span><span style="color:#839c00;">&quot;couchdb_auth_only&quot;</span><span style="color:#111111;">: </span><span style="color:#f07219;">true</span><span style="color:#111111;">,
  </span><span style="color:#839c00;">&quot;members&quot;</span><span style="color:#111111;">: {
    </span><span style="color:#839c00;">&quot;names&quot;</span><span style="color:#111111;">: [],
    </span><span style="color:#839c00;">&quot;roles&quot;</span><span style="color:#111111;">: []
  },
  </span><span style="color:#839c00;">&quot;admins&quot;</span><span style="color:#111111;">: {
    </span><span style="color:#839c00;">&quot;names&quot;</span><span style="color:#111111;">: [],
    </span><span style="color:#839c00;">&quot;roles&quot;</span><span style="color:#111111;">: []
  }
}
</span></code></pre>
<p>Upload it.</p>
<pre style="background-color:#f9f9f9;">
<code class="language-bash" data-lang="bash"><span style="color:#c82728;">curl</span><span style="color:#f07219;"> -X</span><span style="color:#4271ae;"> PUT</span><span style="color:#f07219;"> -u</span><span style="color:#4271ae;"> name:pass https://name.cloudant.com/_users/_security \
</span><span style="color:#f07219;">-H </span><span style="color:#839c00;">&quot;Content-Type: application/json&quot; </span><span style="color:#4271ae;">\
</span><span style="color:#f07219;">-d</span><span style="color:#4271ae;"> @security.json
</span></code></pre><h4 id="create-application-database"><a class="permalink" href="#create-application-database">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    16
  
" height="
  
    16
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Create Application Database</h4>
<p>You need to create a database which will be used as backend of your application. Let's create one called <strong>npm</strong>.</p>
<pre style="background-color:#f9f9f9;">
<code class="language-bash" data-lang="bash"><span style="color:#c82728;">curl</span><span style="color:#f07219;"> -X</span><span style="color:#4271ae;"> PUT</span><span style="color:#f07219;"> -u</span><span style="color:#4271ae;"> name:pass https://name.cloudant.com/npm
</span></code></pre><h6 id="make-it-public"><a class="permalink" href="#make-it-public">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    12
  
" height="
  
    12
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Make it public</h6>
<p>You need to turn off <a href="https://cloudant.com">Cloudant</a>'s security for this database so that you can allow all users to read and write.</p>
<pre style="background-color:#f9f9f9;">
<code class="language-bash" data-lang="bash"><span style="color:#c82728;">curl</span><span style="color:#f07219;"> -X</span><span style="color:#4271ae;"> PUT</span><span style="color:#f07219;"> -u</span><span style="color:#4271ae;"> name:pass https://name.cloudant.com/npm/_security \
</span><span style="color:#f07219;">-H </span><span style="color:#839c00;">&quot;Content-Type: application/json&quot; </span><span style="color:#4271ae;">\
</span><span style="color:#f07219;">-d</span><span style="color:#4271ae;"> @security.json
</span></code></pre><h4 id="secure-application-for-user"><a class="permalink" href="#secure-application-for-user">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    16
  
" height="
  
    16
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Secure Application for User</h4>
<p>You need to add a validation function which runs whenever someone's trying to write to the application database.</p>
<p>Create the validation function as <strong>validation.json</strong>.</p>
<pre style="background-color:#f9f9f9;">
<code class="language-json" data-lang="json"><span style="color:#111111;">{
  </span><span style="color:#839c00;">&quot;_id&quot;</span><span style="color:#111111;">: </span><span style="color:#839c00;">&quot;_design/_auth&quot;</span><span style="color:#111111;">,
  </span><span style="color:#839c00;">&quot;language&quot;</span><span style="color:#111111;">: </span><span style="color:#839c00;">&quot;javascript&quot;</span><span style="color:#111111;">,
  </span><span style="color:#839c00;">&quot;validate_doc_update&quot;</span><span style="color:#111111;">: </span><span style="color:#839c00;">&quot;function(newDoc, oldDoc, userCtx) {</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  function require(beTrue, key, message) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    var err = {};</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    err[key] = message;</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">    if (!beTrue) throw(err);</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  require(userCtx.name, &#39;unauthorized&#39;, &#39;You need to login&#39;);</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (oldDoc) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    require((userCtx.roles.indexOf(&#39;_admin&#39;) != -1 || userCtx.name == oldDoc.user), &#39;forbidden&#39;, &#39;You are not allowed to update it&#39;);</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">}</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">&quot;
</span><span style="color:#111111;">}
</span></code></pre>
<p>Upload it as a design document.</p>
<pre style="background-color:#f9f9f9;">
<code class="language-bash" data-lang="bash"><span style="color:#c82728;">curl</span><span style="color:#f07219;"> -X</span><span style="color:#4271ae;"> POST</span><span style="color:#f07219;"> -u</span><span style="color:#4271ae;"> name:pass https://name.cloudant.com/npm
</span><span style="color:#c82728;">-H </span><span style="color:#839c00;">&quot;Content-Type: application/json&quot; </span><span style="color:#4271ae;">\
</span><span style="color:#f07219;">-d</span><span style="color:#4271ae;"> @validation.json
</span></code></pre>
<p>This validation function is explained <a href="https://pksunkara.com/posts/cloudant-couchdb-as-backend/#application-database">below</a></p>
<h4 id="secure-user-data"><a class="permalink" href="#secure-user-data">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    16
  
" height="
  
    16
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Secure User Data</h4>
<p>You need to secure the authentication database data for users.</p>
<p>Create the validation function as <strong>authentication.json</strong>.</p>
<pre style="background-color:#f9f9f9;">
<code class="language-json" data-lang="json"><span style="color:#111111;">{
  </span><span style="color:#839c00;">&quot;_id&quot;</span><span style="color:#111111;">: </span><span style="color:#839c00;">&quot;_design/_auth&quot;</span><span style="color:#111111;">,
  </span><span style="color:#839c00;">&quot;language&quot;</span><span style="color:#111111;">: </span><span style="color:#839c00;">&quot;javascript&quot;</span><span style="color:#111111;">,
  </span><span style="color:#839c00;">&quot;validate_doc_update&quot;</span><span style="color:#111111;">: </span><span style="color:#839c00;">&quot;function(newDoc, oldDoc, userCtx) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  if (newDoc._deleted === true) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    if (userCtx.roles.indexOf(&#39;_admin&#39;) == -1 &amp;&amp; userCtx.name != oldDoc.name) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      throw({forbidden: &#39;Only admins may delete other user docs.&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">    return;</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if ((oldDoc &amp;&amp; oldDoc.type !== &#39;user&#39;) || newDoc.type !== &#39;user&#39;) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    throw({forbidden : &#39;doc.type must be user&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (!newDoc.name) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    throw({forbidden: &#39;doc.name is required&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (!newDoc.roles) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    throw({forbidden: &#39;doc.roles must exist&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (!isArray(newDoc.roles)) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    throw({forbidden: &#39;doc.roles must be an array&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  for (var idx = 0; idx &lt; newDoc.roles.length; idx++) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    if (typeof newDoc.roles[idx] !== &#39;string&#39;) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      throw({forbidden: &#39;doc.roles can only contain strings&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (newDoc._id !== (&#39;org.couchdb.user:&#39; + newDoc.name)) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    throw({forbidden: &#39;Doc ID must be of the form org.couchdb.user:name&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (oldDoc) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    if (oldDoc.name !== newDoc.name) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      throw({forbidden: &#39;Usernames can not be changed.&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (newDoc.password_sha &amp;&amp; !newDoc.salt) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    throw({forbidden: &#39;Users with password_sha must have a salt. See /_utils/script/couch.js for example code.&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (newDoc.password_scheme === </span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">pbkdf2</span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    if (typeof(newDoc.iterations) !== </span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">number</span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">       throw({forbidden: </span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">iterations must be a number.</span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">    if (typeof(newDoc.derived_key) !== </span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">string</span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">       throw({forbidden: </span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">derived_key must be a string.</span><span style="color:#f07219;">\&quot;</span><span style="color:#839c00;">});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (userCtx.roles.indexOf(&#39;_admin&#39;) == -1) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    if (oldDoc) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      if (userCtx.name !== newDoc.name) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">        throw({forbidden: &#39;You may only update your own user document.&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">      var oldRoles = oldDoc.roles.sort();</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      var newRoles = newDoc.roles.sort();</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">      if (oldRoles.length !== newRoles.length) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">        throw({forbidden: &#39;Only _admin may edit roles&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">      for (var i = 0; i &lt; oldRoles.length; i++) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">        if (oldRoles[i] !== newRoles[i]) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">          throw({forbidden: &#39;Only _admin may edit roles&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">        }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    } else if (newDoc.roles.length &gt; 0) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      throw({forbidden: &#39;Only _admin may set roles&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  for (var i = 0; i &lt; newDoc.roles.length; i++) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    if (newDoc.roles[i][0] === &#39;_&#39;) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      throw({forbidden: &#39;No system roles (starting with underscore) in users db.&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  if (newDoc.name[0] === &#39;_&#39;) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    throw({forbidden: &#39;Username may not start with underscore.&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  var badUserNameChars = [&#39;:&#39;];</span><span style="color:#f07219;">\n\n</span><span style="color:#839c00;">  for (var i = 0; i &lt; badUserNameChars.length; i++) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    if (newDoc.name.indexOf(badUserNameChars[i]) &gt;= 0) {</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">      throw({forbidden: &#39;Character `&#39; + badUserNameChars[i] + &#39;` is not allowed in usernames.&#39;});</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">    }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">  }</span><span style="color:#f07219;">\n</span><span style="color:#839c00;">}&quot;
</span><span style="color:#111111;">}
</span></code></pre>
<p>Upload it as a design document.</p>
<pre style="background-color:#f9f9f9;">
<code class="language-bash" data-lang="bash"><span style="color:#c82728;">curl</span><span style="color:#f07219;"> -X</span><span style="color:#4271ae;"> POST</span><span style="color:#f07219;"> -u</span><span style="color:#4271ae;"> name:pass https://name.cloudant.com/_users
</span><span style="color:#c82728;">-H </span><span style="color:#839c00;">&quot;Content-Type: application/json&quot; </span><span style="color:#4271ae;">\
</span><span style="color:#f07219;">-d</span><span style="color:#4271ae;"> @authentication.json
</span></code></pre>
<p>This validation function is explained <a href="https://pksunkara.com/posts/cloudant-couchdb-as-backend/#users-database">below</a>.</p>
<h2 id="explanations"><a class="permalink" href="#explanations">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    20
  
" height="
  
    20
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Explanations</h2>
<p>This section explains how the validation functions work.</p>
<h3 id="application-database"><a class="permalink" href="#application-database">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    18
  
" height="
  
    18
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Application Database</h3>
<pre style="background-color:#f9f9f9;">
<code class="language-js" data-lang="js"><span style="color:#8959a8;">function</span><span style="color:#111111;">(</span><span style="color:#f07219;">newDoc</span><span style="color:#111111;">, </span><span style="color:#f07219;">oldDoc</span><span style="color:#111111;">, </span><span style="color:#f07219;">userCtx</span><span style="color:#111111;">) {

  </span><span style="color:#8959a8;">function </span><span style="color:#4271ae;">require</span><span style="color:#111111;">(</span><span style="color:#f07219;">beTrue</span><span style="color:#111111;">, </span><span style="color:#f07219;">key</span><span style="color:#111111;">, </span><span style="color:#f07219;">message</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">var </span><span style="color:#c82728;">err </span><span style="color:#3e999f;">= </span><span style="color:#111111;">{};
    </span><span style="color:#c82728;">err</span><span style="color:#111111;">[</span><span style="color:#c82728;">key</span><span style="color:#111111;">] </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">message</span><span style="color:#111111;">;

    </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#3e999f;">!</span><span style="color:#c82728;">beTrue</span><span style="color:#111111;">) </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">(</span><span style="color:#c82728;">err</span><span style="color:#111111;">);
  }

  </span><span style="color:#8e908c;">// You need the user to be logged in
  </span><span style="color:#4271ae;">require</span><span style="color:#111111;">(</span><span style="color:#c82728;">userCtx</span><span style="color:#111111;">.name, </span><span style="color:#839c00;">&#39;unauthorized&#39;</span><span style="color:#111111;">, </span><span style="color:#839c00;">&#39;You need to login&#39;</span><span style="color:#111111;">);

  </span><span style="color:#8e908c;">// If the user is updating a document, you need to make sure he owns it
  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">oldDoc</span><span style="color:#111111;">) {
    </span><span style="color:#4271ae;">require</span><span style="color:#111111;">((</span><span style="color:#c82728;">userCtx</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">roles</span><span style="color:#4271ae;">.indexOf</span><span style="color:#111111;">(</span><span style="color:#839c00;">&#39;_admin&#39;</span><span style="color:#111111;">) </span><span style="color:#3e999f;">!= -</span><span style="color:#f07219;">1 </span><span style="color:#3e999f;">|| </span><span style="color:#c82728;">userCtx</span><span style="color:#111111;">.name </span><span style="color:#3e999f;">== </span><span style="color:#c82728;">oldDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">user</span><span style="color:#111111;">), </span><span style="color:#839c00;">&#39;forbidden&#39;</span><span style="color:#111111;">, </span><span style="color:#839c00;">&#39;You are not allowed to update it&#39;</span><span style="color:#111111;">);
  }
}
</span></code></pre>
<p><a name="user-explanation"></a></p>
<h4 id="users-database"><a class="permalink" href="#users-database">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    16
  
" height="
  
    16
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Users Database</h4>
<pre style="background-color:#f9f9f9;">
<code class="language-js" data-lang="js"><span style="color:#8959a8;">function</span><span style="color:#111111;">(</span><span style="color:#f07219;">newDoc</span><span style="color:#111111;">, </span><span style="color:#f07219;">oldDoc</span><span style="color:#111111;">, </span><span style="color:#f07219;">userCtx</span><span style="color:#111111;">) {
  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">_deleted </span><span style="color:#3e999f;">=== </span><span style="color:#f07219;">true</span><span style="color:#111111;">) {
    </span><span style="color:#8e908c;">// Allow deletes by admins and matching users without checking the other fields
    </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">userCtx</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">roles</span><span style="color:#4271ae;">.indexOf</span><span style="color:#111111;">(</span><span style="color:#839c00;">&#39;_admin&#39;</span><span style="color:#111111;">) </span><span style="color:#3e999f;">== -</span><span style="color:#f07219;">1 </span><span style="color:#3e999f;">&amp;&amp; </span><span style="color:#c82728;">userCtx</span><span style="color:#111111;">.name </span><span style="color:#3e999f;">!= </span><span style="color:#c82728;">oldDoc</span><span style="color:#111111;">.name) {
      </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;Only admins may delete other user docs.&#39;</span><span style="color:#111111;">});
    }

    </span><span style="color:#8959a8;">return</span><span style="color:#111111;">;
  }

  </span><span style="color:#8e908c;">// We only allow user docs for now
  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">((</span><span style="color:#c82728;">oldDoc </span><span style="color:#3e999f;">&amp;&amp; </span><span style="color:#c82728;">oldDoc</span><span style="color:#111111;">.type </span><span style="color:#3e999f;">!== </span><span style="color:#839c00;">&#39;user&#39;</span><span style="color:#111111;">) </span><span style="color:#3e999f;">|| </span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.type </span><span style="color:#3e999f;">!== </span><span style="color:#839c00;">&#39;user&#39;</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden : </span><span style="color:#839c00;">&#39;doc.type must be user&#39;</span><span style="color:#111111;">});
  }

  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#3e999f;">!</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.name) {
    </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;doc.name is required&#39;</span><span style="color:#111111;">});
  }

  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#3e999f;">!</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">roles</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;doc.roles must exist&#39;</span><span style="color:#111111;">});
  }

  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#3e999f;">!</span><span style="color:#4271ae;">isArray</span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">roles</span><span style="color:#111111;">)) {
    </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;doc.roles must be an array&#39;</span><span style="color:#111111;">});
  }

  </span><span style="color:#8959a8;">for </span><span style="color:#111111;">(</span><span style="color:#8959a8;">var </span><span style="color:#c82728;">idx </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span style="color:#111111;">; </span><span style="color:#c82728;">idx </span><span style="color:#3e999f;">&lt; </span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">roles</span><span style="color:#111111;">.length; </span><span style="color:#c82728;">idx</span><span style="color:#3e999f;">++</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#3e999f;">typeof </span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">roles</span><span style="color:#111111;">[</span><span style="color:#c82728;">idx</span><span style="color:#111111;">] </span><span style="color:#3e999f;">!== </span><span style="color:#839c00;">&#39;string&#39;</span><span style="color:#111111;">) {
      </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;doc.roles can only contain strings&#39;</span><span style="color:#111111;">});
    }
  }

  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">_id </span><span style="color:#3e999f;">!== </span><span style="color:#111111;">(</span><span style="color:#839c00;">&#39;org.couchdb.user:&#39; </span><span style="color:#3e999f;">+ </span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.name)) {
    </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;Doc ID must be of the form org.couchdb.user:name&#39;</span><span style="color:#111111;">});
  }

  </span><span style="color:#8e908c;">// Don&#39;t allow usernames to be changed
  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">oldDoc</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">oldDoc</span><span style="color:#111111;">.name </span><span style="color:#3e999f;">!== </span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.name) {
      </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;Usernames can not be changed.&#39;</span><span style="color:#111111;">});
    }
  }

  </span><span style="color:#8e908c;">// Password logic
  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">password_sha </span><span style="color:#3e999f;">&amp;&amp; !</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">salt</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;Users with password_sha must have a salt. See /_utils/script/couch.js for example code.&#39;</span><span style="color:#111111;">});
  }

  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">password_scheme </span><span style="color:#3e999f;">=== </span><span style="color:#839c00;">&quot;pbkdf2&quot;</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#3e999f;">typeof</span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">iterations</span><span style="color:#111111;">) </span><span style="color:#3e999f;">!== </span><span style="color:#839c00;">&quot;number&quot;</span><span style="color:#111111;">) {
       </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&quot;iterations must be a number.&quot;</span><span style="color:#111111;">});
    }

    </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#3e999f;">typeof</span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">derived_key</span><span style="color:#111111;">) </span><span style="color:#3e999f;">!== </span><span style="color:#839c00;">&quot;string&quot;</span><span style="color:#111111;">) {
       </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&quot;derived_key must be a string.&quot;</span><span style="color:#111111;">});
    }
  }

  </span><span style="color:#8e908c;">// If user is not server admin
  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">userCtx</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">roles</span><span style="color:#4271ae;">.indexOf</span><span style="color:#111111;">(</span><span style="color:#839c00;">&#39;_admin&#39;</span><span style="color:#111111;">) </span><span style="color:#3e999f;">== -</span><span style="color:#f07219;">1</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">oldDoc</span><span style="color:#111111;">) {
      </span><span style="color:#8e908c;">// Allow user to update only their documents
      </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">userCtx</span><span style="color:#111111;">.name </span><span style="color:#3e999f;">!== </span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.name) {
        </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;You may only update your own user document.&#39;</span><span style="color:#111111;">});
      }

      </span><span style="color:#8e908c;">// Validate role updates
      </span><span style="color:#8959a8;">var </span><span style="color:#c82728;">oldRoles </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">oldDoc</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">roles</span><span style="color:#4271ae;">.sort</span><span style="color:#111111;">();
      </span><span style="color:#8959a8;">var </span><span style="color:#c82728;">newRoles </span><span style="color:#3e999f;">= </span><span style="color:#c82728;">newDoc</span><span style="color:#4271ae;">.</span><span style="color:#c82728;">roles</span><span style="color:#4271ae;">.sort</span><span style="color:#111111;">();

      </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">oldRoles</span><span style="color:#111111;">.length </span><span style="color:#3e999f;">!== </span><span style="color:#c82728;">newRoles</span><span style="color:#111111;">.length) {
        </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;Only _admin may edit roles&#39;</span><span style="color:#111111;">});
      }

      </span><span style="color:#8959a8;">for </span><span style="color:#111111;">(</span><span style="color:#8959a8;">var </span><span style="color:#c82728;">i </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span style="color:#111111;">; </span><span style="color:#c82728;">i </span><span style="color:#3e999f;">&lt; </span><span style="color:#c82728;">oldRoles</span><span style="color:#111111;">.length; </span><span style="color:#c82728;">i</span><span style="color:#3e999f;">++</span><span style="color:#111111;">) {
        </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">oldRoles</span><span style="color:#111111;">[</span><span style="color:#c82728;">i</span><span style="color:#111111;">] </span><span style="color:#3e999f;">!== </span><span style="color:#c82728;">newRoles</span><span style="color:#111111;">[</span><span style="color:#c82728;">i</span><span style="color:#111111;">]) {
          </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;Only _admin may edit roles&#39;</span><span style="color:#111111;">});
        }
      }
    } </span><span style="color:#8959a8;">else if </span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">roles</span><span style="color:#111111;">.length </span><span style="color:#3e999f;">&gt; </span><span style="color:#f07219;">0</span><span style="color:#111111;">) {
      </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;Only _admin may set roles&#39;</span><span style="color:#111111;">});
    }
  }

  </span><span style="color:#8e908c;">// Character validations
  </span><span style="color:#8959a8;">for </span><span style="color:#111111;">(</span><span style="color:#8959a8;">var </span><span style="color:#c82728;">i </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span style="color:#111111;">; </span><span style="color:#c82728;">i </span><span style="color:#3e999f;">&lt; </span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">roles</span><span style="color:#111111;">.length; </span><span style="color:#c82728;">i</span><span style="color:#3e999f;">++</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.</span><span style="color:#c82728;">roles</span><span style="color:#111111;">[</span><span style="color:#c82728;">i</span><span style="color:#111111;">][</span><span style="color:#f07219;">0</span><span style="color:#111111;">] </span><span style="color:#3e999f;">=== </span><span style="color:#839c00;">&#39;_&#39;</span><span style="color:#111111;">) {
      </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;No system roles (starting with underscore) in users db.&#39;</span><span style="color:#111111;">});
    }
  }

  </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#111111;">.name[</span><span style="color:#f07219;">0</span><span style="color:#111111;">] </span><span style="color:#3e999f;">=== </span><span style="color:#839c00;">&#39;_&#39;</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;Username may not start with underscore.&#39;</span><span style="color:#111111;">});
  }

  </span><span style="color:#8959a8;">var </span><span style="color:#c82728;">badUserNameChars </span><span style="color:#3e999f;">= </span><span style="color:#111111;">[</span><span style="color:#839c00;">&#39;:&#39;</span><span style="color:#111111;">];

  </span><span style="color:#8959a8;">for </span><span style="color:#111111;">(</span><span style="color:#8959a8;">var </span><span style="color:#c82728;">i </span><span style="color:#3e999f;">= </span><span style="color:#f07219;">0</span><span style="color:#111111;">; </span><span style="color:#c82728;">i </span><span style="color:#3e999f;">&lt; </span><span style="color:#c82728;">badUserNameChars</span><span style="color:#111111;">.length; </span><span style="color:#c82728;">i</span><span style="color:#3e999f;">++</span><span style="color:#111111;">) {
    </span><span style="color:#8959a8;">if </span><span style="color:#111111;">(</span><span style="color:#c82728;">newDoc</span><span style="color:#4271ae;">.name.indexOf</span><span style="color:#111111;">(</span><span style="color:#c82728;">badUserNameChars</span><span style="color:#111111;">[</span><span style="color:#c82728;">i</span><span style="color:#111111;">]) </span><span style="color:#3e999f;">&gt;= </span><span style="color:#f07219;">0</span><span style="color:#111111;">) {
      </span><span style="color:#8959a8;">throw</span><span style="color:#111111;">({forbidden: </span><span style="color:#839c00;">&#39;Character `&#39; </span><span style="color:#3e999f;">+ </span><span style="color:#c82728;">badUserNameChars</span><span style="color:#111111;">[</span><span style="color:#c82728;">i</span><span style="color:#111111;">] </span><span style="color:#3e999f;">+ </span><span style="color:#839c00;">&#39;` is not allowed in usernames.&#39;</span><span style="color:#111111;">});
    }
  }
}
</span></code></pre><h2 id="addendum"><a class="permalink" href="#addendum">
  <svg viewBox="0 0 16 16" version="1.1" width="
  
    20
  
" height="
  
    20
  
" aria-hidden="true">
    <path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path>
  </svg>
</a>
Addendum</h2>
<p>You need to make sure that every data document you create in the application database needs to have an <strong>user</strong> field which need to be filled with the username of the user. Otherwise the validation function will keep throwing up forbidden errors.</p>
<p>You are now ready to use CouchDB-as-a-backend on <a href="https://cloudant.com">Cloudant</a>. Enjoy!</p>

<div id="social-bar">
  <ul class="rrssb-buttons clearfix">
      <li class="email">
          <a href="mailto:?subject=Cloudant: CouchDB as Backend&amp;body=https%3A&#x2F;&#x2F;pksunkara.com&#x2F;posts&#x2F;cloudant-couchdb-as-backend&#x2F;">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path transform="scale(0.014,-0.014) translate(0,-1670)" d="M1792 826v-794q0 -66 -47 -113t-113 -47h-1472q-66 0 -113 47t-47 113v794q44 -49 101 -87q362 -246 497 -345q57 -42 92.5 -65.5t94.5 -48t110 -24.5h1h1q51 0 110 24.5t94.5 48t92.5 65.5q170 123 498 345q57 39 100 87zM1792 1120q0 -79 -49 -151t-122 -123 q-376 -261 -468 -325q-10 -7 -42.5 -30.5t-54 -38t-52 -32.5t-57.5 -27t-50 -9h-1h-1q-23 0 -50 9t-57.5 27t-52 32.5t-54 38t-42.5 30.5q-91 64 -262 182.5t-205 142.5q-62 42 -117 115.5t-55 136.5q0 78 41.5 130t118.5 52h1472q65 0 112.5 -47t47.5 -113z"/>
                  </svg>
              </span>
              <span class="text">Email</span>
          </a>
      </li>
      <li class="facebook">
          <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A&#x2F;&#x2F;pksunkara.com&#x2F;posts&#x2F;cloudant-couchdb-as-backend&#x2F;" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M27.825,4.783c0-2.427-2.182-4.608-4.608-4.608H4.783c-2.422,0-4.608,2.182-4.608,4.608v18.434 c0,2.427,2.181,4.608,4.608,4.608H14V17.379h-3.379v-4.608H14v-1.795c0-3.089,2.335-5.885,5.192-5.885h3.718v4.608h-3.726 c-0.408,0-0.884,0.492-0.884,1.236v1.836h4.609v4.608h-4.609v10.446h4.916c2.422,0,4.608-2.188,4.608-4.608V4.783z"/>
                  </svg>
              </span>
              <span class="text">Facebook</span>
          </a>
      </li>
      <li class="twitter">
          <a href="http://twitter.com/home?status=Cloudant: CouchDB as Backend%20https%3A&#x2F;&#x2F;pksunkara.com&#x2F;posts&#x2F;cloudant-couchdb-as-backend&#x2F;" class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M24.253,8.756C24.689,17.08,18.297,24.182,9.97,24.62c-3.122,0.162-6.219-0.646-8.861-2.32 c2.703,0.179,5.376-0.648,7.508-2.321c-2.072-0.247-3.818-1.661-4.489-3.638c0.801,0.128,1.62,0.076,2.399-0.155 C4.045,15.72,2.215,13.6,2.115,11.077c0.688,0.275,1.426,0.407,2.168,0.386c-2.135-1.65-2.729-4.621-1.394-6.965 C5.575,7.816,9.54,9.84,13.803,10.071c-0.842-2.739,0.694-5.64,3.434-6.482c2.018-0.623,4.212,0.044,5.546,1.683 c1.186-0.213,2.318-0.662,3.329-1.317c-0.385,1.256-1.247,2.312-2.399,2.942c1.048-0.106,2.069-0.394,3.019-0.851 C26.275,7.229,25.39,8.196,24.253,8.756z"/>
                  </svg>
              </span>
              <span class="text">Twitter</span>
          </a>
      </li>
      <li class="linkedin">
          <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A&#x2F;&#x2F;pksunkara.com&#x2F;posts&#x2F;cloudant-couchdb-as-backend&#x2F;&amp;title=Cloudant: CouchDB as Backend&amp;summary=..." class="popup">
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M25.424,15.887v8.447h-4.896v-7.882c0-1.979-0.709-3.331-2.48-3.331c-1.354,0-2.158,0.911-2.514,1.803 c-0.129,0.315-0.162,0.753-0.162,1.194v8.216h-4.899c0,0,0.066-13.349,0-14.731h4.899v2.088c-0.01,0.016-0.023,0.032-0.033,0.048 h0.033V11.69c0.65-1.002,1.812-2.435,4.414-2.435C23.008,9.254,25.424,11.361,25.424,15.887z M5.348,2.501 c-1.676,0-2.772,1.092-2.772,2.539c0,1.421,1.066,2.538,2.717,2.546h0.032c1.709,0,2.771-1.132,2.771-2.546 C8.054,3.593,7.019,2.501,5.343,2.501H5.348z M2.867,24.334h4.897V9.603H2.867V24.334z"/>
                  </svg>
              </span>
              <span class="text">LinkedIn</span>
          </a>
      </li>
      <li class="tumblr">
          <script>
            document.write('<a href="http://www.tumblr.com/share?v=3&amp;u=' + encodeURIComponent('https%3A&#x2F;&#x2F;pksunkara.com&#x2F;posts&#x2F;cloudant-couchdb-as-backend&#x2F;') + '&amp;t=Cloudant: CouchDB as Backend" class="popup">');
          </script>
              <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M18.02 21.842c-2.029 0.052-2.422-1.396-2.439-2.446v-7.294h4.729V7.874h-4.71V1.592c0 0-3.653 0-3.714 0 s-0.167 0.053-0.182 0.186c-0.218 1.935-1.144 5.33-4.988 6.688v3.637h2.927v7.677c0 2.8 1.7 6.7 7.3 6.6 c1.863-0.03 3.934-0.795 4.392-1.453l-1.22-3.539C19.595 21.6 18.7 21.8 18 21.842z"/>
                  </svg>
              </span>
              <span class="text">Tumblr</span>
          <script>document.write('</a>');</script>
      </li>
      <li class="reddit">
          <a href="http://www.reddit.com/submit?url=https%3A&#x2F;&#x2F;pksunkara.com&#x2F;posts&#x2F;cloudant-couchdb-as-backend&#x2F;">
              <span class="icon">
                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <g>
                          <path d="M11.794 15.316c0-1.029-0.835-1.895-1.866-1.895c-1.03 0-1.893 0.865-1.893 1.895s0.863 1.9 1.9 1.9 C10.958 17.2 11.8 16.3 11.8 15.316z"/>
                          <path d="M18.1 13.422c-1.029 0-1.895 0.864-1.895 1.895c0 1 0.9 1.9 1.9 1.865c1.031 0 1.869-0.836 1.869-1.865 C19.969 14.3 19.1 13.4 18.1 13.422z"/>
                          <path d="M17.527 19.791c-0.678 0.678-1.826 1.006-3.514 1.006c-0.004 0-0.009 0-0.014 0c-0.004 0-0.01 0-0.015 0 c-1.686 0-2.834-0.328-3.51-1.005c-0.264-0.265-0.693-0.265-0.958 0c-0.264 0.265-0.264 0.7 0 1 c0.943 0.9 2.4 1.4 4.5 1.402c0.005 0 0 0 0 0c0.005 0 0 0 0 0c2.066 0 3.527-0.459 4.47-1.402 c0.265-0.264 0.265-0.693 0.002-0.958C18.221 19.5 17.8 19.5 17.5 19.791z"/>
                          <path d="M27.707 13.267c0-1.785-1.453-3.237-3.236-3.237c-0.793 0-1.518 0.287-2.082 0.761c-2.039-1.295-4.646-2.069-7.438-2.219 l1.483-4.691l4.062 0.956c0.071 1.4 1.3 2.6 2.7 2.555c1.488 0 2.695-1.208 2.695-2.695C25.881 3.2 24.7 2 23.2 2 c-1.059 0-1.979 0.616-2.42 1.508l-4.633-1.091c-0.344-0.081-0.693 0.118-0.803 0.455l-1.793 5.7 C10.548 8.6 7.7 9.4 5.6 10.75C5.006 10.3 4.3 10 3.5 10.029c-1.785 0-3.237 1.452-3.237 3.2 c0 1.1 0.6 2.1 1.4 2.69c-0.04 0.272-0.061 0.551-0.061 0.831c0 2.3 1.3 4.4 3.7 5.9 c2.299 1.5 5.3 2.3 8.6 2.325c3.228 0 6.271-0.825 8.571-2.325c2.387-1.56 3.7-3.66 3.7-5.917 c0-0.26-0.016-0.514-0.051-0.768C27.088 15.5 27.7 14.4 27.7 13.267z M23.186 3.355c0.74 0 1.3 0.6 1.3 1.3 c0 0.738-0.6 1.34-1.34 1.34s-1.342-0.602-1.342-1.34C21.844 4 22.4 3.4 23.2 3.355z M1.648 13.3 c0-1.038 0.844-1.882 1.882-1.882c0.31 0 0.6 0.1 0.9 0.209c-1.049 0.868-1.813 1.861-2.26 2.9 C1.832 14.2 1.6 13.8 1.6 13.267z M21.773 21.57c-2.082 1.357-4.863 2.105-7.831 2.105c-2.967 0-5.747-0.748-7.828-2.105 c-1.991-1.301-3.088-3-3.088-4.782c0-1.784 1.097-3.484 3.088-4.784c2.081-1.358 4.861-2.106 7.828-2.106 c2.967 0 5.7 0.7 7.8 2.106c1.99 1.3 3.1 3 3.1 4.784C24.859 18.6 23.8 20.3 21.8 21.57z M25.787 14.6 c-0.432-1.084-1.191-2.095-2.244-2.977c0.273-0.156 0.59-0.245 0.928-0.245c1.035 0 1.9 0.8 1.9 1.9 C26.354 13.8 26.1 14.3 25.8 14.605z"/>
                      </g>
                  </svg>
              </span>
              <span class="text">Reddit</span>
          </a>
      </li>
      <li class="pinterest">
          <script>
            var imgurl = "https://pksunkara.com/logo.png";
            var firstimg = document.getElementsByClassName("_index.md-posts/_index.md")[0].getElementsByTagName("img")[0];
            if (firstimg !== undefined) {
              imgurl = firstimg.src;
            }
            document.write('<a href="http://pinterest.com/pin/create/button/?url=https%3A&#x2F;&#x2F;pksunkara.com&#x2F;posts&#x2F;cloudant-couchdb-as-backend&#x2F;&amp;media=' + imgurl + '&amp;description=Cloudant: CouchDB as Backend" class="popup">');
          </script>
              <span class="icon">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewBox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
                      <path d="M14.021,1.57C6.96,1.57,1.236,7.293,1.236,14.355c0,7.062,5.724,12.785,12.785,12.785c7.061,0,12.785-5.725,12.785-12.785 C26.807,7.294,21.082,1.57,14.021,1.57z M15.261,18.655c-1.161-0.09-1.649-0.666-2.559-1.219c-0.501,2.626-1.113,5.145-2.925,6.458 c-0.559-3.971,0.822-6.951,1.462-10.116c-1.093-1.84,0.132-5.545,2.438-4.632c2.837,1.123-2.458,6.842,1.099,7.557 c3.711,0.744,5.227-6.439,2.925-8.775c-3.325-3.374-9.678-0.077-8.897,4.754c0.19,1.178,1.408,1.538,0.489,3.168 C7.165,15.378,6.53,13.7,6.611,11.462c0.131-3.662,3.291-6.227,6.46-6.582c4.007-0.448,7.771,1.474,8.29,5.239 c0.579,4.255-1.816,8.865-6.102,8.533L15.261,18.655z"/>
                  </svg>
              </span>
              <span class="text">Pinterest</span>
          <script>document.write('</a>');</script>
      </li>
      <li class="pocket">
          <a href="https://getpocket.com/save?url=https%3A&#x2F;&#x2F;pksunkara.com&#x2F;posts&#x2F;cloudant-couchdb-as-backend&#x2F;"  class="popup">
              <span class="icon">
                  <svg width="32px" height="28px" viewBox="0 0 32 28" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                      <path d="M28.7817528,0.00172488695 C30.8117487,0.00431221738 31.9749312,1.12074529 31.9644402,3.10781507 C31.942147,6.67703739 32.1336065,10.2669583 31.8057648,13.8090137 C30.7147076,25.5813672 17.2181194,31.8996281 7.20714461,25.3808491 C2.71833574,22.4571656 0.196577202,18.3122624 0.0549495772,12.9357897 C-0.0342233715,9.5774348 0.00642900214,6.21519891 0.0300336062,2.85555035 C0.0405245414,1.1129833 1.21157517,0.0146615391 3.01995012,0.00819321302 C7.34746087,-0.00603710433 11.6775944,0.00431221738 16.0064164,0.00172488695 C20.2644248,0.00172488695 24.5237444,-0.00215610869 28.7817528,0.00172488695 L28.7817528,0.00172488695 Z M8.64885184,7.85611511 C7.38773662,7.99113854 6.66148108,8.42606978 6.29310958,9.33228474 C5.90114134,10.2969233 6.17774769,11.1421181 6.89875951,11.8276216 C9.35282156,14.161969 11.8108164,16.4924215 14.2976518,18.7943114 C15.3844131,19.7966007 16.5354102,19.7836177 17.6116843,18.7813283 C20.0185529,16.5495467 22.4070683,14.2982907 24.7824746,12.0327533 C25.9845979,10.8850542 26.1012707,9.56468083 25.1469132,8.60653379 C24.1361858,7.59255976 22.8449191,7.6743528 21.5890476,8.85191291 C19.9936451,10.3488554 18.3680912,11.8172352 16.8395462,13.3777945 C16.1342655,14.093159 15.7200114,14.0048744 15.0566806,13.3440386 C13.4599671,11.7484252 11.8081945,10.2060421 10.1262706,8.70001155 C9.65564653,8.27936164 9.00411403,8.05345704 8.64885184,7.85611511 L8.64885184,7.85611511 L8.64885184,7.85611511 Z"></path>
                  </svg>
              </span>
              <span class="text">Pocket</span>
          </a>
      </li>
  </ul>
</div>


  </article>
</main>


    <footer id="footer">
      <section id="footer-message">&copy; pksunkara. All rights reserved. Powered by <a href="http://getzola.org" target="_blank">Zola</a>. <a href="https://github.com/kathyqian/crisp-ghost-theme" target="_blank">Crisp</a> theme by <a href="http://kathyqian.com" target="_blank">Kathy Qian</a>.</section>
    </footer>
  </body>
</html>
